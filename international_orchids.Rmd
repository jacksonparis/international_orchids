---
title: "international_orchids"
author: "Jackson Kehoe"
date: "10/31/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(data.table)
library(janitor)
```

```{r, include = FALSE}
setwd("~/Desktop/orchidtrade.exceldata")
xlsxdata = list.files(pattern="*.xlsx")
orchidlist = lapply(xlsxdata, read_xlsx)
```

**My data** <br/>
I decided to go a different direction, and with new data. CITES is an organization that records data pertaining to international transactions of wild plants and animals. I downloaded the data on all plants in the family Orchidaceae (Orchids) since 1975 (the earliest year in their records). I thought this data would be interesting to look at, as it contains information on the orchid species (or at least the genus), as well as where it came from and where it went (along with some other data). I've made a graph showing the top 10 most popular importers into the United States, by totaling counts of recorded imports over the past four years. 

**Other Plans**
For the future, I might look at the most popular genuses to be exported from certain countries over time, or the ratio between imports and exports for certain countries, countries with highest overall importing and exporting, etc. 

```{r, echo = FALSE}
CITES_orchid <- bind_rows(orchidlist) %>% mutate(Taxon2 = Taxon) %>% 
separate(Taxon2, into = c("Genus", "Species"), sep = " ", extra = "merge") %>%
  select("Year", "Taxon", "Genus", "Species", "Importer", "Exporter", "Importer reported quantity", "Exporter reported quantity", "Term", "Unit")
```

```{r, echo = FALSE}

US_imports <- CITES_orchid %>%
  filter(Importer == "US") %>%
  filter(Year %in% 2014:2018) %>%
  group_by(Exporter) %>%
  summarize(Counts = length(Exporter)) %>%
  arrange(desc(Counts)) %>%
  head(10)

ggplot(US_imports, aes(x = reorder(Exporter, -Counts), y = Counts)) + geom_col() + labs(x = "Countries that have exported orchids to US", y = "Recorded exports to US since 2014", title = "From where does the US import orchids?")
```

```{r}
#New Data Alert!!
#I found some cool data about orchids on the IUCN Red List. This is an online database full of different species (not just orchids), their current extinction risks, and a whole lot of other useful information.

IUCN_assessments <- read_xlsx("~/Desktop/redlist_orchid_data/assessments.xlsx")
IUCN_taxonomy <- read_xlsx("~/Desktop/redlist_orchid_data/taxonomy.xlsx")
IUCN_orchids <- IUCN_assessments %>% inner_join(IUCN_taxonomy, by = c("internalTaxonId", "scientificName"))
```

```{r}
#Can I somehow combine these tables? We're about to find out...
all_table <- CITES_orchid %>% inner_join(IUCN_orchids, by = c("Taxon" = "scientificName"))
```

#Some ideas for the future...
#import/export map, globe with arrows connecting

#shiny app?

#use keywords to determine main causes of habitat loss, types of orchids more likely to be endangered

#submit pdf about project to
#causeweb.org/usproc/

#Citing the paper which uses similar data as you: 
#https://academic.oup.com/botlinnean/article/186/4/435/4736317

```{r}
#Reading in the country code data
country_codes <- read.csv("https://pkgstore.datahub.io/core/country-list/data_csv/data/d7c9d7cfb42cb69f4422dec222dbbaa8/data_csv.csv")

#Joining country code data
all_table <- all_table %>%
left_join(country_codes, by = c("Importer" = "Code"))
all_table <- all_table %>%
left_join(country_codes, by = c("Exporter" = "Code"))

#Renaming the columns
setnames(all_table, old=c("Name.x","Name.y"), new=c("importer_country", "exporter_country"))
```

#Next steps:
#Visualize locations of orchids on a 3D globe -- could use coordinate points from IUCN data, or aggregate the orchids into groups based on their threatened level in each country (scroll over a country to see how many IUCN near threatened, threatened, endangered, and critical orchids grow there).
#Visualize import/export of orchids (by genus? subfamily?) based on magnitude for each country. This could be done on a globe or a flat map. Connecting lines/arrows for each shipment, with width varying depending on the number of plants/two circles or a bar chart to indicate import and export of plants, based on total number of shipments or total number of orchids.
#Search "rationale" column in IUCN assessments data (now part of all_table) for keywords or phrases such as "habitat decline," "threat from agriculture" to show trends in the cause of species decline.
#Search "habitat" column for keywords relating to growth habit: "epiphytic" (tree-dwelling), "terrestrial" (soil-dwelling) or "epilithic" (rock-dwelling), to look for links between the growth habit and the natural abundance of plants in the face of changing landscapes. 

```{r}
# Reading in IUCN's point dataset, which contains information 
# regarding locations of plants over many genuses
points <- read_xlsx("~/Desktop/redlist_orchid_points/points_data.xlsx")

# Joining the points dataset with IUCN_assessments to include
# red list categories.
points_plus <- points %>% 
  left_join(IUCN_orchids, by = c("binomial" = "scientificName")) %>%
  select(binomial, longitude, latitude, redlistCategory) %>%
  filter(redlistCategory != "Data Deficient") %>%
  mutate(label = str_c(points_plus$binomial,
                       points_plus$redlistCategory,
                       sep = ", "))

# Ordering levels so they can be colored on the map
points_plus$redlistCategory <- 
  factor(points_plus$redlistCategory,
         levels = c(
           "Extinct",
           "Critically Endangered",
           "Endangered",
           "Vulnerable",
           "Near Threatened",
           "Least Concern"
         ))
```


```{r}
# Making the interactive map with leaflet
library(leaflet)

# Coloring the red list categories
palette <- colorFactor("RdYlGn", points_plus$redlistCategory)

# Putting the map together with leaflet
IUCN_map <- 
  leaflet() %>%
  addProviderTiles(providers$Esri.OceanBasemap) %>%
  setView(lng = 0, lat = 20, zoom = 1.5) %>% 
  addCircleMarkers(data = points_plus, ~longitude, ~latitude,
                   weight = 0.5,
                   col = ~palette(redlistCategory), 
                   fillColor = ~palette(redlistCategory),
                   radius = 3, 
                   fillOpacity = 0.9, 
                   stroke = T, 
                   label = ~points_plus$label
  )
```

#Country data was sourced from datahub.io